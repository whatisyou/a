<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; media-src 'self' blob:; connect-src 'none'; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'">
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연수가 멈췄다</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g' cx='32' cy='32' r='32' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0' stop-color='%231a2555'/%3E%3Cstop offset='1' stop-color='%230b1020'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='url(%23g)' stroke='%237aa2ff' stroke-width='4'/%3E%3Ccircle cx='32' cy='32' r='2.5' fill='%23eaf0ff'/%3E%3Cline x1='32' y1='32' x2='32' y2='16' stroke='%23eaf0ff' stroke-width='4' stroke-linecap='round'/%3E%3Cline x1='32' y1='32' x2='45' y2='32' stroke='%23eaf0ff' stroke-width='4' stroke-linecap='round'/%3E%3Cg stroke='%23304585' stroke-width='2'%3E%3Cline x1='32' y1='6' x2='32' y2='10'/%3E%3Cline x1='32' y1='54' x2='32' y2='58'/%3E%3Cline x1='6' y1='32' x2='10' y2='32'/%3E%3Cline x1='54' y1='32' x2='58' y2='32'/%3E%3C/g%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#0b1020;--panel:#111833;--muted:#8ea0c7;--accent:#7aa2ff;--ok:#2dd4bf;--warn:#fbbf24;--bad:#f87171;--white:#eaf0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 20% -10%,#1a2555 0%,#0b1020 80%);font:15px/1.5 ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;color:var(--white)}
    .wrap{max-width:900px;margin:0 auto;padding:28px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.08);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .header{display:flex;align-items:center;gap:12px;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.07)}
    .logo{width:38px;height:38px;border-radius:11px;background:conic-gradient(from 210deg at 50% 50%, var(--accent), #9bffdc);display:grid;place-items:center;color:#07122a;font-weight:900}
    h1{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:13px}
    .content{padding:20px 24px}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .controls>div{display:flex;gap:6px;align-items:center}
    select,button{height:38px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0a122b;color:var(--white);padding:0 10px}
    button.primary{background:var(--accent);color:#07122a;border:0;font-weight:700}
    button.ghost{background:transparent}
    .meter{margin-top:18px;background:#0a122b;border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:16px}
    .meterbar{height:14px;background:#07122a;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.08)}
    .fill{height:100%;width:0%}
    .stats{display:flex;gap:16px;margin-top:10px;color:var(--muted);font-size:13px;flex-wrap:wrap}
    .stat span{display:block;color:var(--white);font-weight:700;font-size:16px}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);font-size:12px;color:var(--muted)}
    /* toast */
    .toast{position:fixed;right:20px;bottom:20px;display:none;max-width:360px;background:#0c142e;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px 16px;box-shadow:0 12px 30px rgba(0,0,0,.45);z-index:9999}
    .toast.show{display:block;animation:slidein .25s ease-out}
    .toast .title{font-weight:800;margin-bottom:6px}
    .toast .msg{color:var(--muted);font-size:14px}
    .toast.good{border-color:rgba(45,212,191,.35)}
    .toast.warn{border-color:rgba(251,191,36,.35)}
    .toast.bad{border-color:rgba(248,113,113,.35)}
    @keyframes slidein{from{transform:translateY(12px);opacity:0;}to{transform:translateY(0);opacity:1;}}
    .help{margin-top:12px;font-size:13px;color:var(--muted)}
    .link{color:#9bffdc}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="logo">🔕</div>
        <div>
          <h1>연수가 멈췄다</h1>
          <div class="sub">무음이 10초 이상 계속되면 알림. 이후에도 10초마다 누적시간으로 반복 알림.</div>
        </div>
      </div>
      <div class="content">
        <div class="controls">
          <div><label>캡처 소스</label>
            <select id="source">
              <option value="sys">시스템 오디오(배너 표시됨)</option>
              <option value="mic">마이크(배너 없음)</option>
            </select>
          </div>
          <div><label>무음 기준</label>
            <select id="threshold">
              <option value="-45">-45 dB (기본)</option>
              <option value="-40">-40 dB</option>
              <option value="-50">-50 dB</option>
              <option value="-55">-55 dB</option>
              <option value="-60">-60 dB (엄격)</option>
            </select>
          </div>
          <button id="startBtn" class="primary">동작하기</button>
          <button id="stopBtn" class="ghost">정지</button>
          <span class="badge"><strong>알림 조건:</strong>&nbsp;무음 10초 지속 → 이후 10초마다 반복</span>
        </div>

        <div class="meter">
          <div class="meterbar"><div id="fill" class="fill" style="background:linear-gradient(90deg,var(--warn),var(--ok));"></div></div>
          <div class="stats">
            <div class="stat">현재 레벨<span id="dbText">—</span></div>
            <div class="stat">무음 누적<span id="silenceText">0.0s</span></div>
            <div class="stat">상태<span id="stateText">대기</span></div>
          </div>
          <div class="help">
            시스템 오디오 모드에서는 브라우저의 보안 정책 때문에 크롬 상단에 <em>“이 탭을 공유하는 중”</em> 배너가 표시됩니다. 웹페이지에서 이 배너를 숨기는 방법은 제공되지 않습니다.
            배너 없이 사용하려면 <strong>마이크 모드</strong>를 사용하세요. (<a class="link" href="https://developer.mozilla.org/docs/Web/API/MediaDevices/getDisplayMedia" target="_blank">기술 배경</a>)
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast warn">
    <div class="title">알림</div>
    <div class="msg">메시지</div>
  </div>

<script>
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const sourceSel = document.getElementById('source');
const thresholdSel = document.getElementById('threshold');
const dbText = document.getElementById('dbText');
const silenceText = document.getElementById('silenceText');
const stateText = document.getElementById('stateText');
const fill = document.getElementById('fill');
const toast = document.getElementById('toast');

let audioCtx, analyser, mediaStreamSrc, rafId, stream;
let silenceSeconds = 0;
const SILENCE_TRIGGER = 10.0; // seconds
let alarmIntervalId = null;    // for 10s repeating alarms after trigger
let silentPhase = false;       // currently under 'silence' according to dB threshold
let lastFrameTs = null;

function showToast(title='알림', msg='메시지', kind='warn'){
  toast.classList.remove('good','warn','bad');
  toast.classList.add(kind);
  toast.querySelector('.title').textContent = title;
  toast.querySelector('.msg').textContent = msg;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), 6000);
}

async function notifyOS(title='🔕 무음 감지', msg='입력 소스에서 무음이 지속되고 있습니다.'){
  try{
    if('Notification' in window){
      if(Notification.permission === 'default'){
        await Notification.requestPermission();
      }
      if(Notification.permission === 'granted'){
        new Notification(title, { body: msg });
      }
    }
  }catch(e){ /* ignore */ }
}

function rmsToDb(rms){
  const eps = 1e-12;
  return 20 * Math.log10(Math.max(rms, eps)); // dBFS approx
}
function dbToPct(db){ // Map -90..0 dB to 0..100%
  const clamped = Math.max(-90, Math.min(0, db));
  return ((clamped + 90) / 90) * 100;
}

function updateUI(db){
  const pct = dbToPct(db);
  fill.style.width = pct.toFixed(1)+'%';
  dbText.textContent = db.toFixed(1)+' dB';
  silenceText.textContent = silenceSeconds.toFixed(1)+'s';
  stateText.textContent = silentPhase ? '무음 중' : '소리 감지';
}

function clearAlarmInterval(){
  if(alarmIntervalId){
    clearInterval(alarmIntervalId);
    alarmIntervalId = null;
  }
}

function startAlarmLoop(){
  // fire immediately with current accumulated silence, then every 10s
  const fire = () => {
    const sec = Math.floor(silenceSeconds);
    const title = `🔕 무음 지속 ${sec}s`;
    const body = `무음이 ${sec}초 동안 계속되고 있습니다.`;
    showToast(title, body, 'warn');
    notifyOS(title, body);
  };
  fire();
  clearAlarmInterval();
  alarmIntervalId = setInterval(fire, 10_000);
}

function createAnalyser(){
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  analyser.smoothingTimeConstant = 0.4;
}

function measure(){
  const buffer = new Uint8Array(analyser.fftSize);
  analyser.getByteTimeDomainData(buffer);
  // compute RMS from time-domain samples (0..255 center at 128)
  let sumSq = 0;
  for(let i=0;i<buffer.length;i++){
    const v = (buffer[i] - 128) / 128; // approx -1..1
    sumSq += v*v;
  }
  const rms = Math.sqrt(sumSq / buffer.length);
  const db = rmsToDb(rms);

  const now = performance.now();
  if(lastFrameTs == null) lastFrameTs = now;
  const dt = (now - lastFrameTs) / 1000.0;
  lastFrameTs = now;

  const thresholdDb = parseFloat(thresholdSel.value);
  const isSilentNow = db < thresholdDb;

  if(isSilentNow){
    silenceSeconds += dt;
    if(!silentPhase){
      // entering silence
      silentPhase = true;
    }
    // Trigger rule: once silenceSeconds passes SILENCE_TRIGGER, start alarm loop
    if(silenceSeconds >= SILENCE_TRIGGER && !alarmIntervalId){
      startAlarmLoop();
    }
  }else{
    // noise detected -> reset silence state
    silentPhase = false;
    silenceSeconds = 0;
    clearAlarmInterval();
  }

  updateUI(db);
  rafId = requestAnimationFrame(measure);
}

async function start(){
  try{
    stop(); // reset any previous
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    createAnalyser();

    const choice = sourceSel.value;
    if(choice === 'sys'){
      // System/tab audio via getDisplayMedia (shows Chrome sharing banner by design)
      stream = await navigator.mediaDevices.getDisplayMedia({
        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false },
        video: { frameRate: 1, width: 1, height: 1 } // tiny video; we'll ignore it
      });
    }else{
      // Microphone (no banner)
      stream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true },
        video: false
      });
    }

    const audioTrack = stream.getAudioTracks()[0];
    if(!audioTrack){
      showToast('오류', '오디오 트랙을 가져오지 못했습니다.', 'bad');
      return;
    }

    mediaStreamSrc = audioCtx.createMediaStreamSource(stream);
    mediaStreamSrc.connect(analyser);

    lastFrameTs = null;
    silenceSeconds = 0;
    silentPhase = false;
    clearAlarmInterval();
    updateUI(-90);

    if(audioCtx.state === 'suspended'){ await audioCtx.resume(); }
    rafId = requestAnimationFrame(measure);

    showToast('시작됨', choice === 'sys' ? '시스템 오디오를 감시합니다. (배너 표시됨)' : '마이크를 감시합니다. (배너 없음)', 'good');
  }catch(e){
    console.error(e);
    showToast('시작 실패', e.message || String(e), 'bad');
  }
}

function stop(){
  try{
    if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
    if(mediaStreamSrc){ try{ mediaStreamSrc.disconnect(); }catch(e){} mediaStreamSrc = null; }
    if(analyser){ try{ analyser.disconnect(); }catch(e){} analyser = null; }
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    silenceSeconds = 0;
    silentPhase = false;
    lastFrameTs = null;
    clearAlarmInterval();
    updateUI(-90);
    showToast('정지됨', '모니터링을 중지했습니다.', 'good');
  }catch(e){
    console.error(e);
  }
}

  
startBtn.addEventListener('click', start);
stopBtn.addEventListener('click', stop);

// Warm UI
updateUI(-90);

// Safety: stop on page unload or when user hides the tab (optional hardening)
window.addEventListener('beforeunload', stop);
document.addEventListener('visibilitychange', () => {
  // Uncomment next line if you want to auto-stop when tab goes to background:
  // if (document.hidden) stop();
});
</script>
</body>
</html>
