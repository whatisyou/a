<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연수가 멈췄다</title>
  <!-- Clock favicon (SVG data URI) -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%23fff' stroke='%23000' stroke-width='3'/%3E%3Cline x1='32' y1='32' x2='32' y2='16' stroke='%23000' stroke-width='3' stroke-linecap='round'/%3E%3Cline x1='32' y1='32' x2='44' y2='32' stroke='%23000' stroke-width='3' stroke-linecap='round'/%3E%3C/svg%3E" />
  <style>
    :root {
      --bg:#0b1020;
      --card:#111833;
      --fg:#e8ecff;
      --muted:#9aa6d1;
      --accent:#6ea8fe;
      --ok:#2ecc71;
      --warn:#ffcc00;
      --err:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      background: linear-gradient(180deg,#0b1020,#0a0f1f 60%, #081022);
      color:var(--fg);
      min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{
      width:min(860px,100%); background:var(--card); border:1px solid #1d285a; border-radius:20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4); padding:24px;
    }
    h1{margin:0 0 6px; font-size:22px; display:flex; align-items:center; gap:8px}
    .subtitle{color:var(--muted); font-size:14px; margin-bottom:14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      border:0; border-radius:14px; padding:12px 18px; font-weight:700; cursor:pointer;
      background:var(--accent); color:#081022; transition:transform .05s ease;
    }
    button:disabled{opacity:.6; cursor:not-allowed}
    .select-wrap{background:#0d1440; border:1px solid #1f2b66; border-radius:12px; padding:10px 12px}
    select{background:transparent; border:0; color:var(--fg); outline:none}
    .stat{margin-left:auto; font-monospace: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:var(--muted)}
    .meter{
      width:100%; height:12px; background:#0f1430; border-radius:999px; overflow:hidden; margin:10px 0 4px;
      border:1px solid #1f2b66;
    }
    .bar{height:100%; width:0%; background:linear-gradient(90deg, #6ea8fe, #2ecc71)}
    .label{font-size:12px; color:var(--muted)}
    .log{
      margin-top:14px; background:#0b1338; border:1px solid #1b265f; border-radius:12px; padding:12px; height:160px; overflow:auto;
      font:12px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap;
    }
    /* Toast */
    .toast{
      position: fixed; right: 18px; bottom: 18px; background:#0b1338; color:var(--fg);
      border:1px solid #2841a1; border-radius:12px; padding:10px 14px; z-index: 9999; box-shadow:0 10px 20px rgba(0,0,0,.45);
      max-width: 60vw;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>🕒 연수가 멈췄다</h1>
    <div class="subtitle">무음이 10초 이상 지속되면 알림을 보내고, 이후 10초마다 누적 무음 시간을 다시 알립니다.</div>

    <div class="row" style="margin-bottom:8px">
      <div class="select-wrap">
        <label for="mode" class="label">입력</label>
        <select id="mode">
          <option value="mic" selected>마이크</option>
          <option value="system">시스템 소리(화면/탭 공유)</option>
        </select>
      </div>
      <button id="startBtn">동작하기</button>
      <button id="stopBtn" disabled>정지</button>
      <div class="stat"><span id="status">대기</span></div>
    </div>

    <div class="meter"><div id="bar" class="bar"></div></div>
    <div class="label">현재 입력 크기: <span id="level">0.000</span> · 무음 누적: <span id="silence">0.0</span>s</div>

    <div id="log" class="log"></div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const barEl = document.getElementById('bar');
    const levelEl = document.getElementById('level');
    const silenceEl = document.getElementById('silence');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const modeEl = document.getElementById('mode');

    let ctx, analyser, data, rafId, stream;
    let silenceStart = null;
    let lastNotifiedStep = 0; // 0: not yet after first 10s. For 10s, step=1, 20s -> 2 ...
    const SILENCE_THRESHOLD = 0.0035; // empirical ~ -49 dBFS
    const HZ = 10; // checks per second
    const FIRST_BEEP_AT = 10; // seconds
    const REPEAT_EVERY = 10; // seconds

    function log(msg){
      const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.textContent += (logEl.textContent ? '\\n' : '') + line;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(line);
    }

    function showToast(msg, ms=3500){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), ms);
    }

    async function ensureNotifyPermission(){
      if (!('Notification' in window)) return;
      if (Notification.permission === 'default'){
        try { await Notification.requestPermission(); } catch(e){}
      }
    }

    function notifyOS(body){
      const icon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%23fff' stroke='%23000' stroke-width='3'/%3E%3Cline x1='32' y1='32' x2='32' y2='16' stroke='%23000' stroke-width='3' stroke-linecap='round'/%3E%3Cline x1='32' y1='32' x2='44' y2='32' stroke='%23000' stroke-width='3' stroke-linecap='round'/%3E%3C/svg%3E";
      if ('Notification' in window && Notification.permission === 'granted'){
        try{ new Notification('연수가 멈췄다', { body, icon }); }
        catch(e){ showToast(body); }
      } else {
        showToast(body);
      }
    }

    async function getInputStream(){
      const mode = modeEl.value;
      if (mode === 'system'){
        // Requires user to pick a tab/window/screen. Audio must be enabled in picker.
        return await navigator.mediaDevices.getDisplayMedia({ video: true, audio: { echoCancellation:false, noiseSuppression:false } });
      } else {
        return await navigator.mediaDevices.getUserMedia({ audio: { channelCount:1, echoCancellation:false, noiseSuppression:false, autoGainControl:false } });
      }
    }

    function updateUIState(running){
      startBtn.disabled = running;
      stopBtn.disabled = !running;
      statusEl.textContent = running ? '측정 중' : '대기';
    }

    function resetSilence(){
      silenceStart = null;
      lastNotifiedStep = 0;
      silenceEl.textContent = '0.0';
    }

    function rmsFromTimeDomain(u8){
      // Convert 0..255 to -1..1 then RMS
      let sum = 0;
      for (let i=0;i<u8.length;i++){
        const v = (u8[i]-128)/128;
        sum += v*v;
      }
      return Math.sqrt(sum / u8.length);
    }

    function tick(){
      analyser.getByteTimeDomainData(data);
      const rms = rmsFromTimeDomain(data);
      const isSilent = rms < SILENCE_THRESHOLD;

      levelEl.textContent = rms.toFixed(4);
      barEl.style.width = Math.max(2, Math.min(100, Math.round(rms*3000))) + '%';

      const now = performance.now();
      if (isSilent){
        if (silenceStart === null){
          silenceStart = now;
          lastNotifiedStep = 0;
        }
        const elapsed = (now - silenceStart) / 1000;
        silenceEl.textContent = elapsed.toFixed(1);

        if (elapsed >= FIRST_BEEP_AT){
          const step = Math.floor((elapsed - FIRST_BEEP_AT) / REPEAT_EVERY) + 1; // 10s=>1, 20s=>2
          if (step !== lastNotifiedStep){
            lastNotifiedStep = step;
            const total = Math.floor(elapsed);
            notifyOS(`무음 누적 ${total}초`);
            log(`OS 알림: 무음 누적 ${total}초`);
          }
        }
      } else {
        if (silenceStart !== null){
          log(`무음 해제 (누적 ${( (now - silenceStart)/1000 ).toFixed(1)}s)`);
        }
        resetSilence();
      }

      rafId = setTimeout(tick, 1000 / HZ);
    }

    async function start(){
      try{
        updateUIState(true);
        await ensureNotifyPermission();
        resetSilence();

        stream = await getInputStream();
        if (!stream) throw new Error('오디오 입력 스트림 생성 실패');

        // If system mode, try to favor current tab audio only (where supported)
        const audioTracks = stream.getAudioTracks();
        if (!audioTracks || !audioTracks.length){
          throw new Error('오디오 트랙이 없습니다. (화면/탭 공유 시 오디오 포함 선택 필요)');
        }

        ctx = new (window.AudioContext || window.webkitAudioContext)();
        const src = ctx.createMediaStreamSource(stream);
        analyser = ctx.createAnalyser();
        analyser.fftSize = 2048;
        data = new Uint8Array(analyser.fftSize);
        src.connect(analyser);

        log('측정 시작');
        tick();
      } catch (err){
        updateUIState(false);
        const msg = err && err.message ? err.message : String(err);
        log('오류: ' + msg);
        showToast('시작 실패: ' + msg, 5000);
      }
    }

    function stop(){
      try{
        if (rafId){ clearTimeout(rafId); rafId = null; }
        if (ctx){ ctx.close().catch(()=>{}); ctx = null; }
        if (stream){
          stream.getTracks().forEach(t=>t.stop());
          stream = null;
        }
        updateUIState(false);
        resetSilence();
        log('정지');
      } catch(e){}
    }

    // Wire events
    startBtn.addEventListener('click', () => { start(); });
    stopBtn.addEventListener('click', () => { stop(); });

    // Global error guards
    window.addEventListener('error', (e)=>{
      showToast('오류: '+ e.message);
      log('window.error: ' + e.message);
    });
    window.addEventListener('unhandledrejection', (e)=>{
      const m = (e.reason && e.reason.message) ? e.reason.message : String(e.reason);
      showToast('오류: '+ m);
      log('unhandledrejection: ' + m);
    });
  </script>
</body>
</html>
