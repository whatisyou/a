<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Silence Watchdog – 무음 10초 알람</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#111833;--muted:#8ea0c7;--accent:#7aa2ff;--ok:#2dd4bf;--warn:#fbbf24;--bad:#f87171;--white:#eaf0ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 20% -10%,#1a2555 0%,#0b1020 60%),var(--bg);font-family:ui-sans-serif,system-ui,Segoe UI,Apple SD Gothic Neo,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;color:var(--white)}
    .wrap{max-width:900px;margin:0 auto;padding:28px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(6px);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .header{display:flex;align-items:center;gap:12px;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.07)}
    .logo{width:38px;height:38px;border-radius:11px;background:conic-gradient(from 210deg, var(--accent), #9bffdc);display:grid;place-items:center;color:#0b1020;font-weight:800}
    h1{font-size:20px;line-height:1.2;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    .body{padding:20px 24px}
    .controls{display:grid;grid-template-columns:1.1fr 1fr auto;gap:12px;align-items:end}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    select, input[type="number"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:#0f1530;color:var(--white);outline:none}
    button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .primary{background:var(--accent);color:#07122a;}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--white)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .meter{margin-top:18px;background:#0a122b;border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:16px}
    .meterbar{height:14px;background:#07122a;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.08)}
    .fill{height:100%;width:0%}
    .stats{display:flex;gap:16px;margin-top:10px;color:var(--muted);font-size:13px;flex-wrap:wrap}
    .stat span{display:block;color:var(--white);font-weight:700;font-size:16px}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#0a1433;border:1px solid rgba(255,255,255,.1);font-size:12px;color:var(--muted)}

    /* toast */
    .toast{position:fixed;right:20px;bottom:20px;display:none;max-width:340px;background:#0b152f;border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:14px 16px;box-shadow:0 12px 30px rgba(0,0,0,.45);z-index:9999}
    .toast.show{display:block;animation:slidein .25s ease-out}
    .toast .title{font-weight:800;margin-bottom:6px}
    .toast .msg{color:var(--muted)}
    .toast.ok{border-color:rgba(45,212,191,.5)}
    .toast.warn{border-color:rgba(251,191,36,.5)}
    .toast.bad{border-color:rgba(248,113,113,.5)}
    @keyframes slidein{from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1}}

    footer{padding:14px 24px;border-top:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
    .link{color:var(--accent);text-decoration:none}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px dashed rgba(255,255,255,.2);border-radius:999px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="logo">SW</div>
        <div>
          <h1>Silence Watchdog <span style="opacity:.6">· 무음 10초 알람</span></h1>
          <div class="sub">오디오 입력에서 10초 이상 무음(임계치 이하) 상태가 지속되면 오른쪽 하단 알림을 띄웁니다.</div>
        </div>
      </div>
      <div class="body">
        <div class="controls">
          <div>
            <label>캡처 소스</label>
            <select id="source">
              <option value="mic">마이크 (getUserMedia)</option>
              <option value="system">시스템 오디오 (화면 공유 + 오디오)</option>
            </select>
          </div>
          <div>
            <label>무음 판정 임계치 (dBFS)</label>
            <select id="threshold">
              <option value="-45">-45 dB (권장)</option>
              <option value="-50">-50 dB</option>
              <option value="-55">-55 dB</option>
              <option value="-60">-60 dB (가장 엄격)</option>
            </select>
          </div>
          <div class="row" style="gap:8px">
            <button id="startBtn" class="primary">동작하기</button>
            <button id="stopBtn" class="ghost">정지</button>
          </div>
        </div>

        <div class="meter">
          <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
            <div class="badge">실시간 레벨 미터</div>
            <div class="chip"><span>알림 조건:</span> <strong>무음 10초 지속</strong></div>
          </div>
          <div class="meterbar">
            <div id="fill" class="fill"></div>
          </div>
          <div class="stats">
            <div class="stat">현재 레벨(dBFS)<span id="dbText">—</span></div>
            <div class="stat">무음 누적<span id="silenceText">0.0s</span></div>
            <div class="stat">상태<span id="stateText">대기</span></div>
          </div>
        </div>
      </div>
      <footer>
        <div>권한 허용이 필요합니다. 시스템 오디오는 <b>Chrome/Edge</b>에서 화면 공유 시 "시스템 오디오 공유" 옵션을 선택하세요.</div>
        <div><a class="link" href="https://developer.mozilla.org/docs/Web/API/MediaDevices" target="_blank" rel="noreferrer">MDN: MediaDevices</a></div>
      </footer>
    </div>
  </div>

  <div id="toast" class="toast warn">
    <div class="title">🔕 무음 10초 감지</div>
    <div class="msg">입력 소스에서 10초 이상 무음이 지속되었습니다.</div>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const sourceSel = document.getElementById('source');
    const thresholdSel = document.getElementById('threshold');
    const dbText = document.getElementById('dbText');
    const silenceText = document.getElementById('silenceText');
    const stateText = document.getElementById('stateText');
    const fill = document.getElementById('fill');
    const toast = document.getElementById('toast');

    let audioCtx, analyser, mediaStreamSrc, rafId, stream;
    let silenceSeconds = 0;
    const SILENCE_REQUIRED = 10.0; // seconds
    let alerted = false;

    function showToast(kind='warn', title='🔕 무음 10초 감지', msg='입력 소스에서 10초 이상 무음이 지속되었습니다.'){
      toast.classList.remove('ok','bad','warn');
      toast.classList.add(kind);
      toast.querySelector('.title').textContent = title;
      toast.querySelector('.msg').textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 6000);
    }

    async function notifyOS(){
      try{
        if('Notification' in window){
          if(Notification.permission === 'default'){
            await Notification.requestPermission();
          }
          if(Notification.permission === 'granted'){
            new Notification('🔕 무음 10초 감지', { body:'입력 소스에서 10초 이상 무음이 지속되었습니다.' });
          }
        }
      }catch(e){/* ignore */}
    }

    function rmsToDb(rms){
      const eps = 1e-12;
      return 20 * Math.log10(Math.max(rms, eps)); // dBFS approx
    }

    function dbToPct(db){
      // Map -90..0 dB to 0..100%
      const clamped = Math.max(-90, Math.min(0, db));
      return ((clamped + 90) / 90) * 100;
    }

    function getThresholdDb(){
      return parseFloat(thresholdSel.value);
    }

    function updateUI(db){
      dbText.textContent = isFinite(db) ? db.toFixed(1) + ' dB' : '—';
      silenceText.textContent = silenceSeconds.toFixed(1) + 's';
      fill.style.width = dbToPct(db).toFixed(1) + '%';
      fill.style.background = db < getThresholdDb() ? 'linear-gradient(90deg,#f59e0b,#fbbf24)' : 'linear-gradient(90deg,#34d399,#10b981)';
      stateText.textContent = db < getThresholdDb() ? '무음 감지중' : '소리 있음';
    }

    function analyzeLoop(){
      const buf = new Float32Array(analyser.fftSize);
      let last = performance.now();

      const tick = () => {
        rafId = requestAnimationFrame(tick);
        analyser.getFloatTimeDomainData(buf);
        // RMS
        let sum = 0;
        for(let i=0;i<buf.length;i++){
          const v = buf[i];
          sum += v*v;
        }
        const rms = Math.sqrt(sum / buf.length);
        const db = rmsToDb(rms);
        const now = performance.now();
        const dt = (now - last)/1000;
        last = now;

        if(db < getThresholdDb()){
          silenceSeconds += dt;
          if(!alerted && silenceSeconds >= SILENCE_REQUIRED){
            alerted = true;
            showToast('warn');
            notifyOS();
          }
        }else{
          silenceSeconds = 0;
          alerted = false; // allow re-alert after sound resumes
        }
        updateUI(db);
      };
      tick();
    }

    async function start(){
      try{
        stop();
        const choice = sourceSel.value;
        if(choice === 'mic'){
          stream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}});
        }else{
          // System audio via display capture; user must tick "system audio" in picker (Chrome/Edge)
          // Video track is required by spec in many browsers to receive audio.
          stream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
        }
        if(!stream) throw new Error('오디오 스트림을 가져오지 못했습니다.');

        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(audioCtx.state === 'suspended'){
          await audioCtx.resume();
        }
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        mediaStreamSrc = audioCtx.createMediaStreamSource(stream);
        mediaStreamSrc.connect(analyser);
        analyzeLoop();
        showToast('ok','✅ 모니터링 시작','무음이 10초 지속되면 알림을 띄웁니다.');
      }catch(err){
        console.error(err);
        showToast('bad','❌ 시작 실패', err.message || '권한 또는 브라우저 설정을 확인하세요.');
      }
    }

    function stop(){
      if(rafId) cancelAnimationFrame(rafId); rafId = null;
      if(mediaStreamSrc){
        try{mediaStreamSrc.disconnect();}catch(e){}
        mediaStreamSrc = null;
      }
      if(analyser){try{analyser.disconnect();}catch(e){} analyser = null;}
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      silenceSeconds = 0; alerted = false; updateUI(-90);
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);

    // Warm UI
    updateUI(-90);
  </script>
</body>
</html>
